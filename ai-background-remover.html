<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Background Remover - Bring Your Own Key | OnlineWebTool</title>
    <style>
        /* [Keep all your beautiful CSS styles from your previous code here] */
        /* Just add this new block for the API key section */
        .api-key-section {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgb(0, 213, 255);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }
        .api-key-box {
            margin: 20px auto;
            max-width: 600px;
        }
        .api-key-input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgb(0, 213, 255);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-family: monospace;
            margin-bottom: 15px;
        }
        .api-key-input::placeholder {
            color: #888;
        }
        .key-step {
            background: rgba(0, 213, 255, 0.1);
            border-left: 4px solid rgb(0, 213, 255);
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            border-radius: 0 8px 8px 0;
        }
    </style>
</head>
<body>
    <!-- [Keep your existing Header, Title Section, etc.] -->
    <header>...</header>
    <div class="container">...</div>

    <!-- NEW SECTION: API KEY SETUP GUIDE -->
    <div class="container">
        <div class="api-key-section">
            <h2><span>üîë</span> How to Use This Tool</h2>
            <p class="subtitle">Follow these 3 simple steps to power the AI with your own free key</p>

            <div class="key-step">
                <h3>Step 1: Get Your Free API Key</h3>
                <p>This tool uses the <strong>Remove.bg</strong> service. You need your own key.</p>
                <a href="https://www.remove.bg/api" target="_blank" class="btn-primary" style="display: inline-block; margin: 10px 0;">
                    <span>üöÄ</span> Get Free Key at Remove.bg
                </a>
                <p><small>Click the link above ‚Üí Sign up for free ‚Üí Go to "API" section ‚Üí Copy your key.</small></p>
            </div>

            <div class="key-step">
                <h3>Step 2: Paste Your Key Here</h3>
                <p>Your key is only used in your browser and is never saved on our server.</p>
                <div class="api-key-box">
                    <input type="password" 
                           id="userApiKey" 
                           class="api-key-input" 
                           placeholder="Paste your Remove.bg API key here (looks like 'API-xxxxxxxxxxxxxx')">
                    <button class="btn-secondary" onclick="saveKey()">
                        <span>üíæ</span> Save Key for This Session
                    </button>
                </div>
            </div>

            <div class="key-step">
                <h3>Step 3: Upload & Remove Background</h3>
                <p>Once your key is saved above, you can upload any image and use the tool!</p>
            </div>
        </div>
    </div>

    <!-- [Keep your existing Tool Card, Upload Section, Preview, etc.] -->
    <div class="tool-card">...</div>

    <!-- UPDATED SCRIPT SECTION -->
    <script>
        // ==================== API KEY HANDLING ====================
        const API_KEY_INPUT = document.getElementById('userApiKey');
        const REMOVE_BG_API_URL = 'https://api.remove.bg/v1.0/removebg';

        // Try to load a previously saved key for this session
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = sessionStorage.getItem('userRemoveBgKey');
            if (savedKey) {
                API_KEY_INPUT.value = savedKey;
                showKeyStatus('‚úÖ Using your saved key for this session.', 'success');
            }
        });

        // Save the key to browser's session storage
        function saveKey() {
            const key = API_KEY_INPUT.value.trim();
            if (!key) {
                showKeyStatus('‚ö†Ô∏è Please paste your API key first.', 'error');
                return;
            }
            if (!key.startsWith('API-')) {
                showKeyStatus('‚ö†Ô∏è Key should start with "API-". Check your Remove.bg account.', 'error');
                return;
            }
            sessionStorage.setItem('userRemoveBgKey', key);
            showKeyStatus('‚úÖ Key saved! You can now use the tool. This key will last until you close your browser.', 'success');
        }

        function showKeyStatus(message, type) {
            // Create or update a status element
            let statusEl = document.getElementById('keyStatus');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'keyStatus';
                statusEl.style.cssText = 'padding:10px; margin:15px 0; border-radius:5px; text-align:center; font-weight:bold;';
                API_KEY_INPUT.parentNode.appendChild(statusEl);
            }
            statusEl.textContent = message;
            statusEl.style.background = type === 'success' ? 'rgba(0,255,200,0.2)' : 'rgba(255,100,100,0.2)';
            statusEl.style.border = type === 'success' ? '1px solid #00ffc8' : '1px solid #ff6464';
            statusEl.style.color = type === 'success' ? '#00ffc8' : '#ff6464';
        }

        // ==================== UPDATED BACKGROUND REMOVAL FUNCTION ====================
        async function removeBackground() {
            // 1. Check if user has provided an API key
            const userApiKey = sessionStorage.getItem('userRemoveBgKey') || API_KEY_INPUT.value.trim();
            if (!userApiKey) {
                showStatus('‚ùå Please get and paste your free API key first (Step 2 above).', 'error');
                return;
            }

            // 2. Check if an image is uploaded
            if (!originalImageData) {
                showStatus('Please upload an image first', 'error');
                return;
            }

            // 3. Start processing
            processingOverlay.classList.add('active');
            removeBtn.disabled = true;

            try {
                // Convert the uploaded image for the API
                const imageBlob = dataURLToBlob(originalImageData);
                const formData = new FormData();
                formData.append('image_file', imageBlob, currentFileName + '.png');
                formData.append('size', 'auto'); // Let Remove.bg choose the best size

                // 4. Call Remove.bg API WITH THE USER'S KEY
                const response = await fetch(REMOVE_BG_API_URL, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': userApiKey, // User's key goes here
                    },
                    body: formData
                });

                // 5. Handle API response
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error (${response.status}): ${errorText || 'Check your API key and quota.'}`);
                }

                // 6. Success! Get the processed image
                const resultBlob = await response.blob();
                processedImageData = URL.createObjectURL(resultBlob);

                // 7. Display the result
                displayProcessedImage(processedImageData);

                // 8. Finish up
                processingOverlay.classList.remove('active');
                downloadBtn.style.display = 'flex';
                removeBtn.disabled = false;
                showStatus('‚úÖ Background removed successfully using your API key!', 'success');

            } catch (error) {
                console.error('Background removal failed:', error);
                processingOverlay.classList.remove('active');
                removeBtn.disabled = false;
                showStatus(`‚ùå Failed: ${error.message}`, 'error');
            }
        }

        // Helper function to convert Data URL to Blob (needed for API)
        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const byteString = atob(parts[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mime });
        }

        // [Keep all your other existing functions: handleFileSelect, showPreviewSection, downloadImage, etc.]
    </script>
</body>
</html>
